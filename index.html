<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>baotg10 | Đổi địa chỉ cũ → mới (vietnam-address-converter)</title>

  <!-- Browser build của vietnam-address-converter -->
  <script src="https://unpkg.com/vietnam-address-converter@latest/dist/index.browser.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg0:#070b14; --bg1:#0b1220;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#e5e7eb; --muted:#94a3b8;
      --p1:#3b82f6; --p2:#8b5cf6; --p3:#ec4899;
      --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px; --r2:12px;
      --w: 1040px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(139,92,246,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 95%, rgba(236,72,153,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh; display:flex; justify-content:center; padding:26px;
    }
    .wrap{width:min(var(--w),100%);}
    .top{display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:14px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, var(--p1), var(--p2), var(--p3));
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:2px; border-radius:12px;
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.38), transparent 45%),
                  radial-gradient(circle at 70% 65%, rgba(255,255,255,.20), transparent 45%),
                  rgba(0,0,0,.10);
      mix-blend-mode: screen;
    }
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; margin-top:3px}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      font-size:12px;
    }
    .pill .mono{font-family:var(--mono)}
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.03));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:14px 16px;
      background: linear-gradient(90deg, rgba(59,130,246,.12), rgba(139,92,246,.10), rgba(236,72,153,.10));
      border-bottom:1px solid var(--border);
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      cursor:pointer; user-select:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:8px 10px; border-radius:999px;
      font-size:13px;
    }
    .tab.active{border-color: rgba(59,130,246,.45); background: rgba(59,130,246,.14);}
    .body{padding:16px;}
    .grid{display:grid; grid-template-columns: 1.1fr 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .box{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: var(--r2);
      padding:12px;
    }
    .box h2{margin:0 0 10px 0; font-size:14px; letter-spacing:.2px;}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    textarea, input{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:130px; resize:vertical; line-height:1.4}
    input:focus, textarea:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 3px rgba(59,130,246,.18);
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      letter-spacing:.2px;
    }
    button.primary{
      border:none;
      background: linear-gradient(135deg, var(--p1), var(--p2));
      box-shadow: 0 14px 30px rgba(59,130,246,.18);
    }
    button.danger{border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.5}
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size:13px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: var(--mono);
    }
    .ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10)}
    .err{border-color: rgba(239,68,68,.38); background: rgba(239,68,68,.10)}
    .warn{border-color: rgba(245,158,11,.38); background: rgba(245,158,11,.10)}
    .result{font-family:var(--sans); white-space:normal}
    .line{margin:8px 0}
    .k{color:var(--muted)}
    .v{font-weight:800}
    .mono{font-family:var(--mono)}
    .table{
      width:100%; border-collapse:separate; border-spacing:0;
      overflow:hidden; border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      margin-top:10px;
    }
    .table th,.table td{
      padding:10px 10px; font-size:13px; border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    .table th{color:var(--muted); text-align:left; background: rgba(255,255,255,.04)}
    .table tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Đổi địa chỉ cũ → mới</h1>
          <div class="sub">Dùng quangtam/vietnam-address-converter — sửa lỗi object hiển thị</div>
        </div>
      </div>
      <div class="pill">
        <span class="muted">DB</span>
        <span class="mono" id="dbPill"></span>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div class="tabs">
          <div class="tab active" data-tab="single">Địa chỉ đơn lẻ</div>
          <div class="tab" data-tab="batch">Chuyển đổi hàng loạt</div>
          <div class="tab" data-tab="settings">Cấu hình</div>
        </div>
        <div class="muted" id="libState">Chưa khởi tạo dữ liệu…</div>
      </div>

      <div class="body">
        <!-- SINGLE -->
        <div class="pane" id="pane-single">
          <div class="grid">
            <div class="box">
              <h2>1) Nhập địa chỉ cũ</h2>
              <label>Địa chỉ (chuỗi)</label>
              <textarea id="singleInput" placeholder="Ví dụ: Phường 12, Quận Gò Vấp, Thành phố Hồ Chí Minh"></textarea>

              <div class="btns">
                <button class="primary" id="btnSingleConvert">Chuyển đổi</button>
                <button id="btnSingleExample">Điền ví dụ</button>
                <button class="danger" id="btnSingleClear">Xóa</button>
              </div>

              <div class="hint">
                Lưu ý: kết quả trả về có thể là object. Tool này sẽ tự format thành chuỗi.
              </div>

              <div class="status" id="singleStatus">Sẵn sàng.</div>
            </div>

            <div class="box">
              <h2>2) Kết quả</h2>
              <div class="status result" id="singleResult">Chưa có kết quả.</div>

              <table class="table" id="singleTable" style="display:none">
                <thead>
                  <tr>
                    <th>Trường</th>
                    <th>Giá trị</th>
                  </tr>
                </thead>
                <tbody id="singleTbody"></tbody>
              </table>

              <div class="btns">
                <button id="btnCopyNew">Copy địa chỉ mới</button>
                <button id="btnCopyJsonSingle">Copy JSON</button>
              </div>
            </div>
          </div>
        </div>

        <!-- BATCH -->
        <div class="pane" id="pane-batch" style="display:none">
          <div class="grid">
            <div class="box">
              <h2>1) Dán danh sách (mỗi dòng 1 địa chỉ)</h2>
              <label>Danh sách địa chỉ cũ</label>
              <textarea id="batchInput" placeholder="Mỗi dòng 1 địa chỉ...
Ví dụ:
Phường 12, Quận Gò Vấp, Thành phố Hồ Chí Minh
Phường 15, Quận 10, TP.HCM"></textarea>

              <div class="btns">
                <button class="primary" id="btnBatchConvert">Chuyển đổi hàng loạt</button>
                <button id="btnBatchExample">Dán ví dụ</button>
                <button class="danger" id="btnBatchClear">Xóa</button>
              </div>

              <div class="hint">Batch chạy offline: convert từng dòng, xuất bảng + CSV.</div>
              <div class="status" id="batchStatus">Sẵn sàng.</div>
            </div>

            <div class="box">
              <h2>2) Kết quả</h2>

              <div class="btns">
                <button id="btnCopyCsv">Copy CSV (old,new,success,message)</button>
                <button id="btnCopyJsonBatch">Copy JSON</button>
              </div>

              <div class="status result" id="batchResult">Chưa có kết quả.</div>

              <table class="table" id="batchTable" style="display:none">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Địa chỉ cũ</th>
                    <th>Địa chỉ mới</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody id="batchTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="pane" id="pane-settings" style="display:none">
          <div class="grid">
            <div class="box">
              <h2>Cấu hình nguồn dữ liệu mapping</h2>

              <label>URL address.json</label>
              <input id="dbUrl" />

              <div class="btns">
                <button class="primary" id="btnInit">Khởi tạo / Nạp lại dữ liệu</button>
                <button id="btnResetDb">Reset mặc định</button>
              </div>

              <div class="hint">
                Mặc định dùng database từ unpkg: <span class="mono">vietnam-address-database@latest/address.json</span>
              </div>

              <div class="status" id="initStatus">Chưa khởi tạo.</div>
            </div>

            <div class="box">
              <h2>Debug nhanh</h2>
              <div class="status result">
                Nếu vẫn không map ra, hãy bấm “Copy JSON” rồi dán JSON vào chat để mình chỉnh format/đọc field đúng schema bạn đang nhận.
              </div>
            </div>
          </div>
        </div>

      </div><!-- body -->
    </div><!-- card -->
  </div><!-- wrap -->

<script>
(() => {
  // ---------------- Tabs ----------------
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const panes = {
    single: document.getElementById("pane-single"),
    batch: document.getElementById("pane-batch"),
    settings: document.getElementById("pane-settings"),
  };
  tabs.forEach(t => t.addEventListener("click", () => {
    tabs.forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.getAttribute("data-tab");
    Object.entries(panes).forEach(([k,el]) => el.style.display = (k === tab) ? "" : "none");
  }));

  // ---------------- Helpers ----------------
  const $ = (id) => document.getElementById(id);
  const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
  const setStatus = (el, msg, type="") => {
    el.classList.remove("ok","err","warn");
    if(type) el.classList.add(type);
    el.textContent = msg;
  };
  const setHtml = (el, html, type="") => {
    el.classList.remove("ok","err","warn");
    if(type) el.classList.add(type);
    el.innerHTML = html;
  };
  const toCsv = (rows) =>
    rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(",")).join("\n");
  const parseLines = (text) => (text || "").split(/\r?\n/).map(x => x.trim()).filter(Boolean);

  // ✅ FIX CHÍNH: format object -> string address
  function bestStringFromObject(obj){
    // ưu tiên các key hay gặp
    const directKeys = [
      "fullAddress","full_address","full_name","fullName","address","name","text","value"
    ];
    for(const k of directKeys){
      if(obj && obj[k] != null && String(obj[k]).trim() !== "") return String(obj[k]).trim();
    }
    return "";
  }

  function pickAreaName(area){
    if(!area || typeof area !== "object") return "";
    const type = bestStringFromObject({fullAddress: area.type, name: area.type});
    const name = bestStringFromObject({fullAddress: area.name, name: area.name, full_name: area.full_name});
    if(type && name) return `${type} ${name}`.trim();
    return (name || type || "").trim();
  }

  function formatAddress(val){
    if(val == null) return "";
    if(typeof val === "string") return val.trim();

    if(typeof val === "object"){
      // 1) nếu object có sẵn fullAddress/full_name/address -> lấy luôn
      const direct = bestStringFromObject(val);
      if(direct) return direct;

      // 2) thử dựng từ các field hành chính hay gặp
      const parts = [];

      const street = bestStringFromObject({street: val.street, streetAddress: val.streetAddress, address: val.streetAddress});
      if(street) parts.push(street);

      // ward/district/province có thể nằm ở nhiều tên khác nhau
      const ward = val.ward || val.newWard || val.wardInfo || val.new_ward;
      const district = val.district || val.districtInfo || val.oldDistrict || val.old_district;
      const province = val.province || val.provinceInfo || val.newProvince || val.new_province;

      const w = pickAreaName(ward);
      const d = pickAreaName(district);
      const p = pickAreaName(province);

      if(w) parts.push(w);
      if(d) parts.push(d);
      if(p) parts.push(p);

      if(parts.length) return parts.join(", ");

      // 3) fallback: stringify gọn
      try { return JSON.stringify(val); } catch { return String(val); }
    }

    return String(val).trim();
  }

  // ---------------- Converter Init ----------------
  let converter = null;
  let isReady = false;

  const DB_URL_DEFAULT = "https://unpkg.com/vietnam-address-database@latest/address.json";
  const KEY_DB_URL = "baotg10_vac_db_url";

  const dbUrlInput = $("dbUrl");
  const dbPill = $("dbPill");
  const libState = $("libState");
  const initStatus = $("initStatus");

  function getDbUrl(){ return localStorage.getItem(KEY_DB_URL) || DB_URL_DEFAULT; }
  function setDbUrl(v){ localStorage.setItem(KEY_DB_URL, v); }

  function pillText(url){
    const u = (url || "").replace("https://","").replace("http://","");
    return u.length > 44 ? (u.slice(0,44) + "…") : u;
  }

  async function initConverter(){
    const dbUrl = (dbUrlInput.value || "").trim();
    if(!dbUrl){
      setStatus(initStatus, "URL dữ liệu trống.", "err");
      return;
    }
    if(!window.VietnamAddressConverter || !window.VietnamAddressConverter.VietnamAddressConverter){
      setStatus(initStatus, "Không load được thư viện vietnam-address-converter (CDN).", "err");
      libState.textContent = "Lỗi thư viện.";
      return;
    }

    setStatus(initStatus, "Đang tải dữ liệu mapping…", "warn");
    libState.textContent = "Đang khởi tạo…";
    try{
      converter = new window.VietnamAddressConverter.VietnamAddressConverter();
      await converter.initializeFromUrl(dbUrl);
      isReady = true;
      setStatus(initStatus, "Khởi tạo xong ✅", "ok");
      libState.textContent = "Sẵn sàng ✅";
    }catch(e){
      isReady = false;
      setStatus(initStatus, "Lỗi khởi tạo: " + (e?.message || e), "err");
      libState.textContent = "Chưa sẵn sàng ❌";
    }
  }

  // load settings
  dbUrlInput.value = getDbUrl();
  dbPill.textContent = pillText(dbUrlInput.value);

  $("btnResetDb").addEventListener("click", () => {
    dbUrlInput.value = DB_URL_DEFAULT;
    setDbUrl(DB_URL_DEFAULT);
    dbPill.textContent = pillText(DB_URL_DEFAULT);
    setStatus(initStatus, "Đã reset. Bấm Khởi tạo để nạp lại.", "warn");
  });

  $("btnInit").addEventListener("click", async () => {
    const v = (dbUrlInput.value || "").trim();
    setDbUrl(v);
    dbPill.textContent = pillText(v);
    await initConverter();
  });

  // auto init
  initConverter();

  // ---------------- SINGLE ----------------
  const singleInput = $("singleInput");
  const singleStatus = $("singleStatus");
  const singleResult = $("singleResult");
  const singleTable = $("singleTable");
  const singleTbody = $("singleTbody");
  let lastSingle = null;

  function renderSingle(res){
    lastSingle = res;

    if(!res){
      setHtml(singleResult, "Chưa có kết quả.");
      singleTable.style.display = "none";
      return;
    }

    const oldText = formatAddress(res.originalAddress);
    const newText = formatAddress(res.convertedAddress);
    const mappingType = res.mappingInfo?.mappingType || res.mappingType || "";

    if(!res.success){
      setHtml(singleResult,
        `<div class="line"><span class="k">Lỗi:</span> <span class="v">${esc(res.message || "Không rõ lỗi")}</span></div>`,
        "err"
      );
      singleTbody.innerHTML = `
        <tr><td>success</td><td>false</td></tr>
        <tr><td>message</td><td>${esc(res.message || "")}</td></tr>
      `;
      singleTable.style.display = "";
      return;
    }

    setHtml(singleResult, `
      <div class="line"><span class="k">Địa chỉ cũ:</span><br><span class="v">${esc(oldText || "(không có)")}</span></div>
      <div class="line"><span class="k">Địa chỉ mới:</span><br><span class="v">${esc(newText || "(không có)")}</span></div>
      <div class="line"><span class="k">Mapping type:</span> <span class="mono">${esc(mappingType || "(không có)")}</span></div>
    `, "ok");

    singleTbody.innerHTML = `
      <tr><td>success</td><td>true</td></tr>
      <tr><td>originalAddress</td><td>${esc(oldText)}</td></tr>
      <tr><td>convertedAddress</td><td><b>${esc(newText)}</b></td></tr>
      <tr><td>mappingType</td><td>${esc(mappingType)}</td></tr>
    `;
    singleTable.style.display = "";
  }

  $("btnSingleConvert").addEventListener("click", () => {
    if(!isReady || !converter){
      setStatus(singleStatus, "Chưa khởi tạo dữ liệu. Vào tab Cấu hình bấm Khởi tạo.", "err");
      return;
    }
    const text = (singleInput.value || "").trim();
    if(!text){
      setStatus(singleStatus, "Bạn chưa nhập địa chỉ.", "warn");
      return;
    }
    try{
      setStatus(singleStatus, "Đang chuyển đổi…", "warn");
      const res = converter.convertAddress(text);
      renderSingle(res);
      setStatus(singleStatus, res?.success ? "Xong ✅" : "Không chuyển đổi được ❌", res?.success ? "ok" : "err");
    }catch(e){
      setStatus(singleStatus, "Lỗi: " + (e?.message || e), "err");
    }
  });

  $("btnSingleExample").addEventListener("click", () => {
    singleInput.value = "Phường 12, Quận Gò Vấp, Thành phố Hồ Chí Minh";
    setStatus(singleStatus, "Đã điền ví dụ. Bấm Chuyển đổi.", "warn");
  });

  $("btnSingleClear").addEventListener("click", () => {
    singleInput.value = "";
    lastSingle = null;
    setStatus(singleStatus, "Đã xóa.", "ok");
    setHtml(singleResult, "Chưa có kết quả.");
    singleTable.style.display = "none";
  });

  $("btnCopyNew").addEventListener("click", async () => {
    const newAddr = formatAddress(lastSingle?.convertedAddress);
    if(!newAddr){
      setStatus(singleStatus, "Chưa có địa chỉ mới để copy.", "warn");
      return;
    }
    await navigator.clipboard.writeText(newAddr);
    setStatus(singleStatus, "Đã copy địa chỉ mới.", "ok");
  });

  $("btnCopyJsonSingle").addEventListener("click", async () => {
    if(!lastSingle){
      setStatus(singleStatus, "Chưa có JSON để copy.", "warn");
      return;
    }
    await navigator.clipboard.writeText(JSON.stringify(lastSingle, null, 2));
    setStatus(singleStatus, "Đã copy JSON.", "ok");
  });

  // ---------------- BATCH ----------------
  const batchInput = $("batchInput");
  const batchStatus = $("batchStatus");
  const batchResult = $("batchResult");
  const batchTable = $("batchTable");
  const batchTbody = $("batchTbody");
  let lastBatch = null;

  $("btnBatchConvert").addEventListener("click", () => {
    if(!isReady || !converter){
      setStatus(batchStatus, "Chưa khởi tạo dữ liệu. Vào tab Cấu hình bấm Khởi tạo.", "err");
      return;
    }
    const lines = parseLines(batchInput.value);
    if(!lines.length){
      setStatus(batchStatus, "Danh sách trống.", "warn");
      return;
    }

    setStatus(batchStatus, `Đang chuyển đổi ${lines.length} dòng…`, "warn");
    const results = [];

    for(let i=0;i<lines.length;i++){
      const oldAddr = lines[i];
      try{
        const r = converter.convertAddress(oldAddr);
        results.push({
          index: i+1,
          old: oldAddr,
          new: formatAddress(r?.convertedAddress),
          success: !!r?.success,
          message: r?.success ? "" : (r?.message || "Không chuyển đổi được"),
          raw: r
        });
      }catch(e){
        results.push({
          index: i+1,
          old: oldAddr,
          new: "",
          success: false,
          message: e?.message || String(e),
          raw: null
        });
      }
    }

    lastBatch = results;

    const okCount = results.filter(x => x.success).length;
    const failCount = results.length - okCount;

    setHtml(batchResult, `
      <div class="line"><span class="k">Tổng:</span> <span class="v">${results.length}</span></div>
      <div class="line"><span class="k">Thành công:</span> <span class="v">${okCount}</span></div>
      <div class="line"><span class="k">Thất bại:</span> <span class="v">${failCount}</span></div>
    `, okCount ? "ok" : "warn");

    batchTbody.innerHTML = results.map(r => `
      <tr>
        <td class="mono">${r.index}</td>
        <td>${esc(r.old)}</td>
        <td>${r.success ? "<b>"+esc(r.new)+"</b>" : "<span class='muted'>(trống)</span>"}</td>
        <td class="mono">${r.success ? "OK" : "FAIL: " + esc(r.message)}</td>
      </tr>
    `).join("");

    batchTable.style.display = "";
    setStatus(batchStatus, "Xong ✅", "ok");
  });

  $("btnBatchExample").addEventListener("click", () => {
    batchInput.value =
`Phường 12, Quận Gò Vấp, Thành phố Hồ Chí Minh
Phường 15, Quận 10, TP.HCM
Phường An Lạc, Quận Bình Tân, TP.HCM`;
    setStatus(batchStatus, "Đã dán ví dụ. Bấm Chuyển đổi hàng loạt.", "warn");
  });

  $("btnBatchClear").addEventListener("click", () => {
    batchInput.value = "";
    lastBatch = null;
    batchTable.style.display = "none";
    setHtml(batchResult, "Chưa có kết quả.");
    setStatus(batchStatus, "Đã xóa.", "ok");
  });

  $("btnCopyJsonBatch").addEventListener("click", async () => {
    if(!lastBatch){
      setStatus(batchStatus, "Chưa có JSON để copy.", "warn");
      return;
    }
    // compact
    const compact = lastBatch.map(r => ({
      index: r.index, old: r.old, new: r.new, success: r.success, message: r.message
    }));
    await navigator.clipboard.writeText(JSON.stringify(compact, null, 2));
    setStatus(batchStatus, "Đã copy JSON batch.", "ok");
  });

  $("btnCopyCsv").addEventListener("click", async () => {
    if(!lastBatch){
      setStatus(batchStatus, "Chưa có dữ liệu để copy CSV.", "warn");
      return;
    }
    const rows = [["old","new","success","message"]];
    lastBatch.forEach(r => rows.push([r.old, r.new, r.success, r.message]));
    await navigator.clipboard.writeText(toCsv(rows));
    setStatus(batchStatus, "Đã copy CSV.", "ok");
  });

})();
</script>
</body>
</html>
