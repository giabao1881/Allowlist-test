<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chuyển Đổi Địa Chỉ Cũ → Mới (Hàng loạt)</title>

  <script src="https://unpkg.com/vietnam-address-converter@latest/dist/index.browser.js"></script>

  <style>
    :root{
      --bg1:#5b5fd6; --bg2:#7d4bb7;
      --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
      --primary:#6c63ff; --primary2:#7c3aed;
      --okBg:#eafff0; --okBorder:#a7f3d0; --okText:#166534;
      --warnBg:#fff7ed; --warnBorder:#fed7aa; --warnText:#9a3412;
      --errBg:#fff1f2; --errBorder:#fecdd3; --errText:#9f1239;
      --shadow: 0 18px 60px rgba(15,23,42,.25);
      --r:26px; --r2:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:22px;
      background:
        radial-gradient(900px 520px at 15% 15%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(900px 520px at 80% 10%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .wrap{width:min(1040px,100%);}
    .card{background:var(--card); border-radius:var(--r); box-shadow:var(--shadow); padding:24px;}
    .title{
      display:flex; align-items:center; justify-content:center; gap:12px;
      font-size:30px; font-weight:850; margin:6px 0 14px;
    }
    .icon{
      width:42px; height:42px; border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff; box-shadow:0 14px 30px rgba(124,58,237,.25); user-select:none;
    }
    .sub{ text-align:center; color:var(--muted); font-weight:650; margin-bottom:16px; }
    label{display:block; font-weight:800; margin:10px 0 8px;}
    textarea{
      width:100%; border:1px solid var(--line); border-radius:14px;
      padding:14px; font-size:15px; outline:none; background:#fff;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
      min-height:210px; resize:vertical; line-height:1.4;
    }
    textarea:focus{
      border-color: rgba(108,99,255,.50);
      box-shadow: 0 0 0 4px rgba(108,99,255,.14), 0 6px 18px rgba(15,23,42,.06);
    }
    .btn{
      width:100%; margin-top:16px; border:none; border-radius:14px;
      padding:15px 16px; font-size:16px; font-weight:900; color:#fff; cursor:pointer;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      box-shadow: 0 14px 30px rgba(108,99,255,.25);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .miniBtn{
      border:1px solid var(--line); background:#fff; border-radius:12px;
      padding:10px 12px; cursor:pointer; font-weight:850;
    }
    .miniBtn:active{transform: translateY(1px);}
    .box{margin-top:18px; border-radius:var(--r2); border:1px solid var(--line); overflow:hidden;}
    .boxHead{padding:14px 16px; font-weight:900; background:#f8fafc; border-bottom:1px solid var(--line);}
    .status{padding:14px 16px; display:flex; gap:10px; align-items:flex-start;}
    .badge{
      width:22px; height:22px; border-radius:999px;
      display:grid; place-items:center; font-weight:900; flex:0 0 auto;
    }
    .ok{background:var(--okBg); border:1px solid var(--okBorder); color:var(--okText);}
    .warn{background:var(--warnBg); border:1px solid var(--warnBorder); color:var(--warnText);}
    .err{background:var(--errBg); border:1px solid var(--errBorder); color:var(--errText);}
    .msg{font-weight:900;}
    .submsg{margin-top:4px; color:rgba(15,23,42,.72); font-weight:650; white-space:pre-wrap;}

    table{width:100%; border-collapse:collapse; font-size:14px;}
    th,td{border-top:1px solid var(--line); padding:10px; vertical-align:top;}
    th{background:#f8fafc; text-align:left; font-weight:900;}
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      font-weight:900; font-size:12px;
    }
    .pillOk{background:#dcfce7; color:#166534; border:1px solid #86efac;}
    .pillFail{background:#ffe4e6; color:#9f1239; border:1px solid #fecdd3;}
    .pillWarn{background:#fff7ed; color:#9a3412; border:1px solid #fed7aa;}

    .foot{
      margin-top:14px;
      text-align:center;
      color: rgba(15,23,42,.55);
      font-weight:800;
      font-size:12px;
      user-select:none;
    }
    .foot b{color:#0f172a;}

    .options{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed var(--line);
      border-radius:14px;
      background:#fbfdff;
    }
    .opt{
      display:flex; gap:8px; align-items:center;
      font-weight:850; color:#0f172a;
      padding:6px 10px; border-radius:12px;
      background:#fff; border:1px solid var(--line);
      user-select:none;
    }
    .opt input{width:16px; height:16px;}
    .hint{font-weight:700; color:rgba(15,23,42,.65); font-size:12px; margin-top:8px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="title"><div class="icon">⇄</div><div>Chuyển Đổi Địa Chỉ Cũ → Mới</div></div>
      <div class="sub">Hàng loạt • mỗi dòng 1 địa chỉ • giữ số nhà/đường/ấp • viết tắt vẫn hiểu</div>

      <label>Danh sách địa chỉ (mỗi dòng 1 địa chỉ):</label>
      <textarea id="batchInput" placeholder="Ví dụ:
34 ap Binh Long, xa thanh binh, huyen cho gao, tinh tien giang
P4, Q3, TP HCM
tphn, q1, p2
q10 - p15 - tphcm"></textarea>

      <div class="options">
        <label class="opt" title="Chuẩn hóa viết tắt mạnh: TP HCM / HCM / SG / Sai Gon / Q3 / P4...">
          <input type="checkbox" id="optAggressive" checked>
          Chuẩn hóa viết tắt mạnh
        </label>

        <label class="opt" title="Chỉ viết hoa chữ cái đầu (KHÔNG tự đoán dấu).">
          <input type="checkbox" id="optBeautifyStreet" checked>
          Viết hoa phần số nhà/đường (không thêm dấu)
        </label>

        <label class="opt" title="Nếu chuyển đổi FAIL thì vẫn thử nhiều biến thể (raw/chuẩn hóa/không dấu).">
          <input type="checkbox" id="optTryMany" checked>
          Thử nhiều biến thể khi đổi
        </label>
      </div>
      <div class="hint">
        Lưu ý: Tool chỉ có thể “thêm dấu chắc chắn” cho phần hành chính (phường/quận/tỉnh) theo database.
        Phần tên đường/ấp nếu bạn nhập không dấu thì tool KHÔNG đoán dấu để tránh sai.
      </div>

      <button id="btnBatch" class="btn">⇄ Chuyển đổi hàng loạt</button>

      <div class="row">
        <button class="miniBtn" id="btnCopyNewOnly">Copy địa chỉ mới (mỗi dòng 1)</button>
        <button class="miniBtn" id="btnCopyExcel">Copy dán Excel (2 cột: cũ / mới)</button>
        <button class="miniBtn" id="btnCopyResult">Copy kết quả đang hiển thị</button>
      </div>

      <div class="box">
        <div class="boxHead">Kết quả</div>

        <div id="batchStatus" class="status warn">
          <div class="badge warn">i</div>
          <div>
            <div class="msg">Đang tải dữ liệu…</div>
            <div class="submsg">Vui lòng đợi…</div>
          </div>
        </div>

        <div id="batchWrap" style="display:none; padding:16px;">
          <div style="font-weight:900; margin-bottom:8px;">
            Tổng: <span id="batchTotal">0</span> • Thành công: <span id="batchOk">0</span> • Thất bại: <span id="batchFail">0</span>
          </div>

          <div style="overflow:auto; border:1px solid var(--line); border-radius:14px;">
            <table>
              <thead>
                <tr>
                  <th style="width:60px;">#</th>
                  <th>Địa chỉ cũ (1 dòng)</th>
                  <th>Địa chỉ mới (1 dòng)</th>
                  <th style="width:120px;">Trạng thái</th>
                </tr>
              </thead>
              <tbody id="batchBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="foot">Tạo bởi <b>baotg10</b></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function setStatus(type, title, desc){
    const el = $("batchStatus");
    el.className = "status " + type;
    const badge = el.querySelector(".badge");
    badge.className = "badge " + type;
    badge.textContent = type === "ok" ? "✓" : type === "err" ? "!" : "i";
    el.querySelector(".msg").textContent = title;
    el.querySelector(".submsg").textContent = desc || "";
  }

  function escapeHtml(s){
    return (s ?? "").toString().replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function chuanHoaText(s){ return (s ?? "").toString().replace(/\s+/g, " ").trim(); }

  function boDauTiengViet(str){
    return (str || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/đ/g, "d").replace(/Đ/g, "D");
  }

  function tachChuSoDinhNhau(s){
    return (s || "")
      .replace(/([a-zA-ZÀ-ỹĐđ])(\d)/g, "$1 $2")
      .replace(/(\d)([a-zA-ZÀ-ỹĐđ])/g, "$1 $2");
  }

  function chuanHoaDauCach(s){
    return chuanHoaText((s || "")
      .replace(/[|;/]+/g, ",")
      .replace(/[-–—]+/g, ",")
      .replace(/[\\\/]+/g, ",")
      .replace(/\s*,\s*/g, ", "));
  }

  // ✅ NÂNG CẤP: normalize mạnh để bắt TP HCM / Tp Hồ Chí Minh / HCM / SG / Sai Gon...
  function moRongVietTat(s){
    if(!s) return "";
    let x = " " + tachChuSoDinhNhau(s) + " ";

    // normalize -> không dấu + lowercase để match chắc
    x = x.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    x = x.toLowerCase();
    x = x.replace(/\s*\.\s*/g, ".");
    x = x.replace(/\s+/g, " ");

    // ===== TP TRUNG ƯƠNG =====
    x = x.replace(/\b(tp\.?hcm|tphcm|tp ho chi minh|hcm|sg|sai gon)\b/g, " thanh pho ho chi minh ");
    x = x.replace(/\b(tp\.?hn|tphn|tphanoi|tp ha noi|ha noi|hn)\b/g, " thanh pho ha noi ");
    x = x.replace(/\b(tp\.?dn|tp da nang|da nang|danang)\b/g, " thanh pho da nang ");
    x = x.replace(/\b(tp\.?hp|tp hai phong|hai phong|haiphong)\b/g, " thanh pho hai phong ");
    x = x.replace(/\b(tp\.?ct|tp can tho|can tho|cantho)\b/g, " thanh pho can tho ");

    // ===== QUẬN =====
    x = x.replace(/\bq\.?\s*(\d+)\b/g, " quan $1 ");
    x = x.replace(/\bquan\s*(\d+)\b/g, " quan $1 ");

    // ===== PHƯỜNG =====
    x = x.replace(/\bp\.?\s*(\d+)\b/g, " phuong $1 ");
    x = x.replace(/\bphuong\s*(\d+)\b/g, " phuong $1 ");

    // ===== KHÁC =====
    x = x.replace(/\btx\.?\b/g, " thi xa ");
    x = x.replace(/\btt\.?\b/g, " thi tran ");
    x = x.replace(/\bh\.?\b/g, " huyen ");

    return chuanHoaText(x);
  }

  function coTuHanhChinh(token){
    const t = boDauTiengViet(token).toLowerCase();
    return /\b(xa|phuong|thi\s*tran|thi\s*xa|huyen|quan|tinh|thanh\s*pho)\b/.test(t);
  }

  function tachStreetVaHanhChinh(input){
    const raw = chuanHoaText(input);
    if(!raw) return { street:"", admin:"" };

    const parts = chuanHoaDauCach(raw).split(",").map(chuanHoaText).filter(Boolean);

    if(parts.length <= 1){
      const tokens = raw.split(/\s+/);
      let idx = -1;
      for(let i=0;i<tokens.length;i++){
        const w3 = tokens.slice(i, i+3).join(" ");
        if(coTuHanhChinh(tokens[i]) || coTuHanhChinh(w3)){ idx = i; break; }
      }
      if(idx > 0){
        return {
          street: chuanHoaText(tokens.slice(0, idx).join(" ")).replace(/[,]+$/,"").trim(),
          admin:  chuanHoaText(tokens.slice(idx).join(" "))
        };
      }
      return { street:"", admin: raw };
    }

    const first = parts[0];
    if(!coTuHanhChinh(first)){
      return { street:first, admin: parts.slice(1).join(", ") };
    }
    return { street:"", admin: parts.join(", ") };
  }

  function vietHoaDauTu(s){
    s = chuanHoaText(s);
    if(!s) return "";
    return s.split(" ").map(w => w ? w[0].toUpperCase() + w.slice(1) : w).join(" ");
  }

  // ✅ Viết hoa phần street nhưng KHÔNG tự thêm dấu (để tránh sai)
  function beautifyStreetNoAccent(s){
    s = chuanHoaText(s);
    if(!s) return "";
    return s.split(" ").map(w=>{
      if(!w) return w;
      // giữ nguyên token có số / dấu gạch / slash
      if(/[0-9]/.test(w) || /[\/\-]/.test(w)) return w.toUpperCase() === w ? w : w;
      return w[0].toUpperCase() + w.slice(1);
    }).join(" ");
  }

  // ✅ Tự thêm "Tỉnh/Thành phố" nếu thiếu
  function chuanHoaTinhTP(province){
    let p = chuanHoaText(province);
    if(!p) return "";
    const lower = boDauTiengViet(p).toLowerCase();

    if (/\b(tinh|thanh\s*pho)\b/.test(lower)) return vietHoaDauTu(p);

    const tpTW = ["ha noi","ho chi minh","hai phong","da nang","can tho"];
    const isTp = tpTW.some(x => lower.includes(x));

    return isTp ? vietHoaDauTu("Thành phố " + p) : vietHoaDauTu("Tỉnh " + p);
  }

  function formatAddressObject(obj){
    if(!obj || typeof obj !== "object") return "";
    const ward = chuanHoaText(obj.ward);
    const district = chuanHoaText(obj.district);
    const province = chuanHoaText(obj.province);
    const street = chuanHoaText(obj.street || obj.streetAddress);

    const parts = [];
    if(street) parts.push(vietHoaDauTu(street));
    if(ward) parts.push(vietHoaDauTu(ward));
    if(district) parts.push(vietHoaDauTu(district));
    if(province) parts.push(chuanHoaTinhTP(province));
    return parts.join(", ");
  }

  function buildCandidates(input, aggressive){
    const raw = chuanHoaText(input);
    const sep = chuanHoaDauCach(raw);
    const exp = aggressive ? chuanHoaDauCach(moRongVietTat(sep)) : sep;
    const noAcc = boDauTiengViet(exp);

    const list = [raw, sep, exp, noAcc].map(chuanHoaText).filter(Boolean);
    return [...new Set(list)];
  }

  let converter = null;
  let ready = false;
  let lastBatch = null;

  async function init(){
    if(!window.VietnamAddressConverter?.VietnamAddressConverter){
      setStatus("err", "Không tải được thư viện", "Kiểm tra mạng hoặc link unpkg.");
      return;
    }
    setStatus("warn", "Đang tải dữ liệu…", "Vui lòng đợi…");
    try{
      converter = new window.VietnamAddressConverter.VietnamAddressConverter();
      await converter.initializeFromUrl("https://unpkg.com/vietnam-address-database@latest/address.json");
      ready = true;
      setStatus("ok", "Sẵn sàng!", "Dán danh sách rồi bấm chuyển đổi.");
    }catch(e){
      ready = false;
      setStatus("err", "Lỗi tải dữ liệu", e?.message || String(e));
    }
  }

  function tryConvertBest(adminInput, aggressive, tryMany){
    const cands = tryMany ? buildCandidates(adminInput, aggressive) : [chuanHoaText(adminInput)];
    let bestFail = null;

    for(const s of cands){
      try{
        const r = converter.convertAddress(s);
        if(r && r.success) return { ok:true, used:s, res:r };
        bestFail = bestFail || r;
      }catch(e){}
    }
    return { ok:false, used:(cands[0] || ""), res: bestFail || {success:false, message:"Không chuyển đổi được"} };
  }

  $("btnBatch").addEventListener("click", () => {
    if(!ready) return setStatus("warn", "Chưa sẵn sàng", "Đang tải dữ liệu…");
    const lines = ($("batchInput").value || "").split(/\r?\n/).map(chuanHoaText).filter(Boolean);
    if(!lines.length) return setStatus("warn", "Danh sách trống", "Mỗi dòng 1 địa chỉ.");

    const aggressive = $("optAggressive").checked;
    const beautifyStreet = $("optBeautifyStreet").checked;
    const tryMany = $("optTryMany").checked;

    setStatus("warn", "Đang xử lý…", `Đang đổi ${lines.length} dòng`);
    const rows = [];
    let okCount = 0;

    for(let i=0;i<lines.length;i++){
      const raw = lines[i];
      const t = tachStreetVaHanhChinh(raw);

      // adminInput ưu tiên phần hành chính, nếu trống thì dùng raw
      const adminInput = aggressive ? moRongVietTat(t.admin || raw) : (t.admin || raw);

      const payload = tryConvertBest(adminInput, aggressive, tryMany);
      if(payload.ok) okCount++;

      let oldLine = chuanHoaDauCach(raw);
      let newLine = "";
      let msg = payload.ok ? "" : (payload.res?.message || "Không chuyển đổi được");

      if(payload.ok){
        const oldObj = payload.res.originalAddress || {};
        const newObj = payload.res.convertedAddress || {};

        // ✅ QUAN TRỌNG:
        // - street ưu tiên người nhập (t.street) để giữ số nhà/đường/ấp
        // - KHÔNG lấy street từ newObj để tránh bị “đoán sai”
        let street = t.street || (oldObj.street || oldObj.streetAddress || "");
        if(beautifyStreet) street = beautifyStreetNoAccent(street);

        const oldOut = { ward: oldObj.ward, district: oldObj.district, province: oldObj.province, street };
        const newOut = { ward: newObj.ward, district: newObj.district, province: newObj.province, street };

        oldLine = formatAddressObject(oldOut);
        newLine = formatAddressObject(newOut);
      }

      rows.push({
        index:i+1,
        oldLine,
        newLine,
        success: payload.ok,
        message: msg,
        used: payload.used
      });
    }

    lastBatch = rows;

    const failCount = rows.length - okCount;
    $("batchWrap").style.display = "block";
    $("batchTotal").textContent = rows.length;
    $("batchOk").textContent = okCount;
    $("batchFail").textContent = failCount;

    $("batchBody").innerHTML = rows.map(r => `
      <tr>
        <td>${r.index}</td>
        <td>${escapeHtml(r.oldLine)}</td>
        <td>${escapeHtml(r.newLine)}</td>
        <td>
          <span class="pill ${r.success ? "pillOk" : "pillFail"}">${r.success ? "OK" : "FAIL"}</span>
        </td>
      </tr>
    `).join("");

    setStatus("ok", "Xong!", `Thành công ${okCount}/${rows.length}`);
  });

  async function copyToClipboard(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = txt;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      let ok = false;
      try{ ok = document.execCommand("copy"); }catch(_){}
      document.body.removeChild(ta);
      return ok;
    }
  }

  $("btnCopyNewOnly").addEventListener("click", async () => {
    if(!lastBatch) return setStatus("warn", "Chưa có dữ liệu", "Bấm chuyển đổi trước.");
    const txt = lastBatch.map(r => r.newLine || "").join("\n");
    const ok = await copyToClipboard(txt);
    setStatus(ok ? "ok" : "warn", "Copy địa chỉ mới", ok ? "Mỗi dòng 1 địa chỉ" : "Trình duyệt chặn clipboard — hãy copy thủ công.");
  });

  $("btnCopyExcel").addEventListener("click", async () => {
    if(!lastBatch) return setStatus("warn", "Chưa có dữ liệu", "Bấm chuyển đổi trước.");
    const txt = lastBatch.map(r => `${r.oldLine}\t${r.newLine}`).join("\n");
    const ok = await copyToClipboard(txt);
    setStatus(ok ? "ok" : "warn", "Copy dạng Excel", ok ? "Dán vào Excel sẽ ra 2 cột: Cũ | Mới" : "Trình duyệt chặn clipboard — hãy copy thủ công.");
  });

  $("btnCopyResult").addEventListener("click", async () => {
    if(!lastBatch) return setStatus("warn", "Chưa có dữ liệu", "Bấm chuyển đổi trước.");
    const header = "#\tĐịa chỉ cũ\tĐịa chỉ mới\tTrạng thái";
    const body = lastBatch.map(r => `${r.index}\t${r.oldLine}\t${r.newLine}\t${r.success ? "OK" : "FAIL"}`).join("\n");
    const txt = header + "\n" + body;
    const ok = await copyToClipboard(txt);
    setStatus(ok ? "ok" : "warn", "Copy bảng kết quả", ok ? "Bạn có thể dán vào Excel/Sheets" : "Trình duyệt chặn clipboard — hãy copy thủ công.");
  });

  init();
})();
</script>
</body>
</html>
